name: Deploy to EKS on Tag Push

on:
  push:
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ap-south-1
      CLUSTER_NAME: itw-test-project
      DEPLOYMENT_NAME: node-app
      IMAGE_URI: 339713011246.dkr.ecr.ap-south-1.amazonaws.com/nodejs-app-repo:latest

    steps:
    - name: ðŸ“¦ Checkout repository
      uses: actions/checkout@v3

    - name: ðŸ” Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: arn:aws:iam::339713011246:role/github-oidc-deployer-role-v2
        role-session-name: GitHubActionsSession
        aws-region: ap-south-1

    - name: ðŸ§­ Update kubeconfig for EKS
      run: |
        aws eks update-kubeconfig --region $AWS_REGION --name $CLUSTER_NAME

    - name: ðŸ§ª Inject IMAGE_URI into deployment.yaml
      run: |
        cat k8s/deployment.yaml | envsubst > k8s/deployment-patched.yaml

    - name: ðŸš€ Deploy to EKS using kubectl
      run: |
        kubectl apply -f k8s/deployment-patched.yaml
        kubectl apply -f k8s/service.yaml
        kubectl apply -f k8s/ingress.yaml

        echo "ðŸ“¦ Verifying rollout..."
        kubectl rollout status deployment/$DEPLOYMENT_NAME

        echo "ðŸ“¡ Getting service, ingress and pods status..."
        kubectl get svc node-service -o wide
        kubectl get ingress node-service -o wide
        kubectl get pods -l app=$DEPLOYMENT_NAME -o wide
